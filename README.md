# micro-share

Go File sharing HTTP server with auth and user rights management

## setup

### fileserver

```bash
    # dependencies
    $ go get github.com/auth0/go-jwt-middleware github.com/gorilla/handlers github.com/lib/pq github.com/ademilly/auth
    # micro-share
    $ go get github.com/ademilly/micro-share
```

### psql

docker-compose sets up a psql database, storing user data

```bash
    $ docker-compose up -d
    Creating network "micro-share_default" with the default driver
    Creating micro-share_pgsql_1 ... done
```

POSTGRES_USER and POSTGRES_PASSWORD can be defined using a `.env` file or through environment variables.

To initialize the psql database, use the `psql/schema.sql` file with your preferred tool to interact with a psql database. Using the `psql` CLI tool:

```bash
    $ PGUSER=validusername PGPASSWORD=validpassword psql -h localhost -p 5432 < psql/schema.sql
```

## usage

### fileserver

#### cli

```bash
    $ micro-share -h
    Usage: micro-share [options...]
    Environment:
      JWT_KEY: jwt token key
               used for authentication,
               expected to be different than the null string
    Options:
      -certificate string
            [optional] path to TLS certificate file
      -key string
            [optional] path to TLS key file
      -port string
            port number on which to serve (default "8080")
      -root string
            path to root directory containing file to be served (default "/tmp")

    $ JWT_TOKEN=something micro-share
    YYYY/MM/DD HH:mm:ss serving on http://0.0.0.0:8080

    $ JWT_TOKEN=something micro-share -port 80 -root path/to/dir
    YYYY/MM/DD HH:mm:ss serving on http://0.0.0.0:80

    $ JWT_TOKEN=something micro-share -certificate mydomain.crt -key mydomain.key -port 443 -root path/to/dir
    YYYY/MM/DD HH:mm:ss serving on https://0.0.0.0:443
```

The JWT_KEY environment variable is used to initialize the token middleware; thus a token generated by a micro-share service at login with a certain JWT_KEY value can not be used to access another micro-share service using another JWT_KEY value.

#### routes

- `/` used for health checking; serves a welcome message
- `/login` POST to login; data should be send as json in request body
- `/get/[pathtofile]` GET to download file at `pathtofile`; is protected by JWT token

#### examples

Health check:

```bash
    $ curl https://micro-share.mydomain.com
    welcome to this micro-share!
```

Login:

```bash
    $ curl -X POST -H 'Content-Type: application/json' -d '{ "username": "validusername", "password": "validpassword" }' https://micro-share.mydomain.com/login
    SOME.JWT.TOKEN
```

Download file:

```bash
    $ curl -H "Authorization: Bearer SOME.JWT.TOKEN" https://micro-share.mydomain.com/get/somefile
    content of file
```

```bash
    $ wget --header "Authorization: Bearer SOME.JWT.TOKEN" https://0.0.0.0/get/myfile.txt
    => download myfile.txt to myfile.txt
```
